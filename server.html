<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Mono" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <title>ChatServer</title>
  </head>
  <body>
    <nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark px-0">
      <div class="container">
    <a class="navbar-brand col-sm-3 col-md-2 mx-0 px-md-2 pl-sm-3" href="https://github.com/dylanburati/CNChat">CNChat</a>
      <button class="navbar-toggler mr-2" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
              aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav w-100 text-right">
          <li class="nav-item dropdown ml-auto nav-expand-only">
            <a class="nav-link dropdown-toggle" id="navdrop-more" href="#"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              More
            </a>
            <div class="dropdown-menu dropdown-menu-right text-right" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="./client.html">Client Docs</a>
              <a class="dropdown-item" href="./key-exchange.html">Key Exchange</a>
            </div>
          </li>
          <li class="nav-item nav-collapse-only pr-3">
            <a class="nav-link" href="./client.html">Client Docs</a>
          </li>
          <li class="nav-item nav-collapse-only pr-3">
            <a class="nav-link" href="./key-exchange.html">Key Exchange</a>
          </li>
        </ul>
      </div>
    </div>
    </nav>

    <div class="row container-fluid justify-content-center mx-0 px-0">
      <main role="main" class="container d-flex justify-content-center">
        <div class="col-md-10" style="max-width: 1000px !important">

        <div class="px-1 pt-4 pb-2">
          <p class="h2 font-weight-light">ChatServer</p>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="overview"></span>
          <p class="h4">Overview</p>
          <p>
            The ChatServer JAR uses port 8081 to handle users creating new chat sessions,
            and port 8082 to establish WebSocket connections with users.
            Port 8081 should be firewalled, and a sepearate program on the server
            should be used to send the <em>join</em> command to it after checking
            if the user is logged in. Port 8082 should be open to the internet.
          </p>
          <p>
            <a href="#connection-diagram" data-toggle="modal">Show diagram</a>
          </p>
          <div id="connection-diagram" class="modal fade" tabindex="-1" role="dialog"
                  aria-labelledby="connection-diagram-title" aria-hidden="true" style="padding-left: 15px;">
            <div class="modal-dialog" role="document" style="max-width: 1200px !important;">
              <div class="modal-content">
                <div class="modal-header">
                  <p class="h5 mb-2" id="connection-diagram-title">Connection Diagram</p>
                </div>
                <div class="modal-body">
                  <img src="./assets/connection-diag.svg" style="width: 100%; max-width: 100%"></img>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
          <p>
            In order to run the chat app, the server needs to have access to an SSL certificate.
            This is because the page in which the client runs needs
            to be loaded over HTTPS in order to use the <code>window.crypto.subtle</code> object.
          </p>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="environment"></span>
          <p class="h4">Configuration</p>
          <p>
            The server reads a configuration file at startup, called <code>config.json</code>.
            It should be placed in the same directory as the executable, and contain a JSON object.
          </p>
          <p class="mb-1">Configuration options:</p>
          <code class="d-block multiline-text eol-comment" id="define-config">
          </code>
          <p>
            Note: comments are not allowed in the config file.
          </p>
          <p class="mt-2">
            The program can create the tables for messages, conversations, and conversation users at
            runtime. It can't create the table for keys, because that has to be written whenever a user
            registers an account. The keystore table can be created by the command:
          </p>
          <code class="d-block multiline-text" id="define-keystore">
          </code>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="ssl"></span>
          <p class="h4">Creating a JKS from an SSL keychain</p>
          <p>
            In order to import the SSL certificate at runtime, it must be converted to a
            Java key store file with the password "nopassword".
          </p>
          <code class="d-block multiline-text eol-comment-hash" id="define-exportjks">
          </code>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="libraries"></span>
          <p class="h4">Libraries used</p>
          <ul>
            <li>
              <div class="d-flex" style="max-width: 20em;">
                <span style="flex-grow: 1;">jsoniter</span>
                <a class="mr-3" href="https://github.com/json-iterator/java">Github</a>
                <a href="http://jsoniter.com/java-features.html">Docs</a>
              </div>
            </li>
            <li>
              <div class="d-flex" style="max-width: 20em;">
                <span style="flex-grow: 1;">MariaDB Connector/J</span>
                <a class="mr-3" href="https://github.com/MariaDB/mariadb-connector-j">Github</a>
                <a href="https://mariadb.com/kb/en/library/about-mariadb-connector-j/">Docs</a>
              </div>
            </li>
          </ul>
        </div>

        <div class="text-secondary text-center" style="margin-top: 5rem; margin-bottom: 3rem">
          <p class="multiline-text"><a class="text-secondary" href="#">Contact</a>         <span style="position: relative; bottom: .1rem">&#x2B25;</span>         <a class="text-secondary" href="#">About</a></p>
        </div>
      </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript">

document.getElementById('define-config').textContent =
`{
  // defaults to 8081
  "authPort": int,
  // defaults to 8082
  "websocketPort": int,
  // required
  "keyStoreLocation": absolute path to .jks file -- see below,

  // defaults to 3306
  "mariaDBPort": int,
  // required
  "mariaDBUser": string,
  // required
  "mariaDBPassword": string,
  // required
  "database": MariaDB database name,
  // defaults to "$keystore"
  "tableForKeys": table name,
  // defaults to "$cnchat_messages"
  "tableForMessages": table name,
  // defaults to "$cnchat_conversations"
  "tableForConversations": table name,
  // defaults to "$cnchat_conversations_users"
  "tableForConversationsUsers": table name
}`;

document.getElementById('define-keystore').textContent =
`CREATE TABLE $keystore (
  \`name\` VARCHAR(64) NOT NULL,
  \`identity_public\` VARCHAR(768) NOT NULL,
  \`identity_private\` VARCHAR(256) NOT NULL,
  \`prekey_public\` VARCHAR(768) NOT NULL,
  \`prekey_private\` VARCHAR(256) NOT NULL,
  PRIMARY KEY (\`name\`)
);`;

document.getElementById('define-exportjks').textContent =
`#!/bin/bash
#
# Convert a certificate and key to a JKS file
# $1: path to fullchain / certificate
# $2: path to private key

openssl pkcs12 -export \\
    -in "$1" \\
    -inkey "$2" \\
    -out tmp.p12 \\
    -password "pass:1nopassword"

keytool -importkeystore \\
    -deststorepass "nopassword" \\
    -destkeypass "nopassword" \\
    -destkeystore cert.jks \\
    -srckeystore tmp.p12 \\
    -srcstoretype PKCS12 \\
    -srcstorepass "1nopassword"

rm -f tmp.p12
echo "Wrote key store to cert.jks"
`;

function commentAll(el, regex) {
  let parsed = 0;
  const prev = el.innerHTML;
  let inner = '';
  while(parsed < prev.length) {
    const m = regex.exec(prev.substring(parsed));
    if(m == null) {
      break;
    }
    console.log(m);
    const replace = `<span style="color: #2c8147">${m[0]}</span>`;
    const replaceIdx = m.index + parsed;
    inner += prev.substring(parsed, replaceIdx) + replace;
    parsed = replaceIdx + m[0].length;
  }
  inner += prev.substring(parsed);
  el.innerHTML = inner;
}
Array.from(document.querySelectorAll('.eol-comment')).forEach(el => commentAll(el, /\/\/.*\n/));
Array.from(document.querySelectorAll('.eol-comment-hash')).forEach(el => commentAll(el, /#.*\n/));
    </script>
  </body>
</html>
