<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Mono" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet">
    <title>ChatClient</title>
  </head>
  <body>
    <nav class="navbar fixed-top navbar-expand-md navbar-dark bg-dark px-0">
      <div class="container">
    <a class="navbar-brand col-sm-3 col-md-2 mx-0 px-md-2 pl-sm-3" href="https://github.com/dylanburati/CNChat">CNChat</a>
      <button class="navbar-toggler mr-2" type="button" data-toggle="collapse" data-target="#navbarNavDropdown"
              aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav w-100 text-right">
          <li class="nav-item dropdown ml-auto nav-expand-only">
            <a class="nav-link dropdown-toggle" id="navdrop-more" href="#"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              More
            </a>
            <div class="dropdown-menu dropdown-menu-right text-right" aria-labelledby="navbarDropdownMenuLink">
              <a class="dropdown-item" href="./key-exchange.html">Key Exchange</a>
              <a class="dropdown-item" href="./server.html">Server Docs</a>
            </div>
          </li>
          <li class="nav-item nav-collapse-only pr-3">
            <a class="nav-link" href="./key-exchange.html">Key Exchange</a>
          </li>
          <li class="nav-item nav-collapse-only pr-3">
            <a class="nav-link" href="./server.html">Server Docs</a>
          </li>
        </ul>
      </div>
    </div>
    </nav>

    <div class="row container-fluid justify-content-center mx-0 px-0">
      <main role="main" class="container d-flex justify-content-center">
        <div class="col-md-10" style="max-width: 1000px !important">

        <div class="px-1 pt-4 pb-2">
          <p class="h2 font-weight-light">ChatClient</p>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="overview"></span>
          <p class="h4">Overview</p>
          <p>
            The JavaScript client is organized into 3 files: <em>ChatUtils.js</em>, <em>ChatClient.js</em>, and <em>example.js</em>.
          </p>
          <ul>
            <li>ChatUtils provides support for base64 and defines 2 cryptography classes, DHKeyPair and CipherStore.</li>
            <li>
              ChatClient provides the ChatSession class, along with the implementation of the different steps in the
              <a href="./key-exchange.html">key-exchange protocol</a>. It also provides a wrapper around the constructor
              for ChatSession, which attaches a <em>message handler</em> function.
            </li>
            <li>
              example.js is an example of a message handler, leaving out the communication with the user interface. It runs steps
              in the key-exchange protocol or updates the session data based on the content of the message.
            </li>
          </ul>
          <p>
            To use the client, you will need to edit ChatClient.js: the line with <code>new WebSocket(url)</code> must point to the
            public address of the ChatServer, and the function <code>chatClientBegin()</code> must send a request to the server to
            join the chat. For more details on this, see the <a href="./server.html">server docs</a>.
          </p>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="chatsession"></span>
          <p class="h4">ChatSession</p>
          <p>
            The ChatSession object holds the user's conversations, messages, and keysets. It is used to send messages via
            the function <code>enqueue(string, conversationID)</code>.
          </p>
          <p class="mb-2">
            The conversationID 0 represents the server. This conversation does not need to be present in the ChatSession's
            conversation list, as it is not encrypted. To create a new conversation, the client executes:
          </p>
          <code class="ml-3">session.enqueue("conversation_request &lt;user_list&gt;", 0)</code>
          <p class="mt-2">
            where <em>user_list</em> is a semicolon-delimited list of usernames.
          </p>
          <p class="mb-2">
            To send a message to a conversation, the client executes:
          </p>
          <code class="ml-3">session.enqueue(messageText, conversationID)</code> or<br>
          <code class="ml-3">session.enqueueWithContentType(messageText, contentType, conversationID)</code>
          <p class="mt-3 mb-2">
            To update preferences, the client executes:
          </p>
          <code class="ml-3">session.enqueue("conversation_request &lt;changed_preferences&gt;", 0)</code>
          <p class="mt-2 mb-3">
            where <em>changed_preferences</em> is a JSON string with the preference keys and new values
            (currently only one preference is used: <em>markdown</em> is a Boolean indicating whether messages the user
            sends with the default <em>contentType</em> should be formatted with Markdown).
          </p>
          <p class="mb-4">
            These actions should be accessible from the user interface. Everything else is done automatically in
            <em>messageHandler</em>.
          </p>
          <p>
            The ChatSession stores an array called <em>conversations</em>, in which each element is an object with the
            following properties:
          </p>
          <code class="d-block multiline-text">  id: &lt;positive integer&gt;
  users: &lt;array of usernames, including own name&gt;
  cipher: &lt;CipherStore for encrypting and decrypting messages&gt;</code>
          <p>
            The ChatSession stores an array called <em>messages</em>, in which each element is an object with the
            following properties:
          </p>
          <code class="d-block multiline-text">  id: &lt;id of conversation&gt;
  from: &lt;username of the sender&gt;
  time: &lt;timestamp of message in milliseconds since 1970-01-01&gt;
  data: &lt;the content of the message&gt;</code>
          <p>
            These arrays should be used to populate the conversation picker and message panel in the user interface.
          </p>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="compiling"></span>
          <p class="h4">Compiling to ES5</p>
          <p>
            For better browser compatibility, the client JavaScript can be compiled from ECMAScript 6 to ECMAScript 5.
            This will collapse the source files into one bundled file, which can be included in a web page. To do this:
          </p>
          <ol>
            <li class="mb-2">
              Install the following node.js modules:<br>
              <code class="d-block">
                npm install --save-dev @babel/core @babel/cli @babel/polyfill @babel/preset-env webpack webpack-cli
              </code>
            </li>
            <li class="mb-2">
              Create a Babel config file:<br>
              These are the earliest versions that support the required features: SubtleCrypto, WebSockets, and Promises.
              <code class="mt-1 mb-3 d-block" style="white-space: pre-wrap;"
>const presets = [
  [
    "@babel/env",
    {
      targets: {
        ie: "11",
        edge: "12",
        firefox: "34",
        chrome: "37",
        safari: "8",
        opera: "24",
        ios: "8"
      },
      useBuiltIns: "usage"
    },
  ],
];

module.exports = { presets };</code>
              These are the earliest versions that support the required features, plus the Object.assign function, arrow functions and let declarations.
              <code class="mt-1 d-block multiline-text"
>const presets = [
  [
    "@babel/env",
    {
      targets: {
        edge: "12",
        firefox: "44",
        chrome: "49",
        safari: "10",
        opera: "32",
        ios: "10"
      },
      useBuiltIns: "usage"
    },
  ]
];

module.exports = { presets };</code>
            </li>
            <li class="mb-2">
              Concatenate the files to compile:<br>
              <code class="d-block">
                cat path/to/ChatUtils.js path/to/ChatClient.js path/to/example.js &gt; CNChat-es6.js
              </code>
              <p class="ml-4 mt-2 mb-0" style="line-height: 1.35;">
                Note: the functions in the bundle will not be defined in the scope of the window. If your code for the
                user interface needs to access one of them, you can add lines to the end of CNChat-es6.js like this:<br>
                <code class="d-block">window.chatClientBegin = chatClientBegin</code>
              </p>
            </li>
            <li class="mb-2">
              Compile with Babel<br>
              <code class="d-block">
                ./node_modules/.bin/babel --config-file babel.config.js -o CNChat-es5.js CNChat-es6.js
              </code>
            </li>
            <li class="mb-2">
              Preload dependencies with Webpack<br>
              <code class="d-block">
                ./node_modules/.bin/webpack --optimize-minimize -o CNChat-bundle.js CNChat-es5.js
              </code><br>
            </li>
          </ol>
        </div>

        <div class="px-1 py-2">
          <span class="anchor" id="libraries"></span>
          <p class="h4">Libraries used</p>
          <ul>
            <li>
              <div class="d-flex" style="max-width: 15em;">
                <span style="flex-grow: 1;">BigInteger.js</span>
                <a class="mr-3" href="https://github.com/peterolson/BigInteger.js">Github</a>
                <a href="https://www.npmjs.com/package/big-integer">NPM</a>
              </div>
            </li>
            <li>
              <div class="d-flex" style="max-width: 15em;">
                <span style="flex-grow: 1;">Axios</span>
                <a class="mr-3" href="https://github.com/axios/axios">Github</a>
                <a href="https://www.npmjs.com/package/axios">NPM</a>
              </div>
            </li>
          </ul>
        </div>

        <div class="text-secondary text-center" style="margin-top: 5rem; margin-bottom: 3rem">
          <p class="multiline-text"><a class="text-secondary" href="#">Contact</a>         <span style="position: relative; bottom: .1rem">&#x2B25;</span>         <a class="text-secondary" href="#">About</a></p>
        </div>
      </div>
    </main>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"
            integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"
            integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
    <script type="text/javascript">
    </script>
  </body>
</html>
